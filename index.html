<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/css/bootstrap.min.css" 
        rel="stylesheet" 
        integrity="sha384-KyZXEAg3QhqLMpG8r+8fhAXLRk2vvoC2f3B09zVXn8CA5QIVfZOJ3BCsw2P0p/We" 
        crossorigin="anonymous">
<style>
    html,body {
        background: #333;
        color: #FFF;
    }
</style>
<title>Simple Jeopardy! Score Tracker</title>
</head>
<body>
<div class="container-fluid">
<div class="row mt-5 justify-content-md-center">
<div class="col-md-6 text-center">
<div class="bg-dark p-3 rounded-3 shadow-sm">
    <form action="#" id="addplayer">
    <div class="input-group">
        <input type="text" name="playername" id="playername" placeholder="Player name" class="form-control">
        <input type="submit" name="playeradd" value="Add Player" class="btn btn-success">
    </div>
    </form>
    <div>
        <a class="" href="#" onclick="return resetscores()">Reset Scores</a> 
        <a class="" href="#" onclick="return nuke()">Reset All</a>
    </div>
</div>
</div>
<div class="row my-5 justify-content-md-center">
    <div class="col-3 col-md-1 text-center" id="roundone"></div>
    <div class="col-3 col-md-1 text-center" id="roundtwo"></div>
    <div class="col-6 col-md-3" id="app">
        No players yet. Enter names in the box above and click the green "Add Player" button.
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.0/dist/js/bootstrap.bundle.min.js" 
        integrity="sha384-U1DAWAznBHeqEIlVSCgzq+c9gqGAJn5c/t99JyeKa9xxaYpSvHU5awsuZVVFIhvj" 
        crossorigin="anonymous"></script>

<script src="https://cdn.jsdelivr.net/npm/pouchdb@7.2.1/dist/pouchdb.min.js"></script>

<script>

var dbscores = new PouchDB('jeopardyscores');
var dbplayers = new PouchDB('jeopardyplayers');

updatescores();

playersetup();

gridsetup();

function gridsetup () {

    var rocontrols = ''; 
     
    let rndone = [200,400,600,800,1000];
    let rndtwo = [400,800,1200,1600,2000];

    rndone.forEach(function(e,index){
        dbplayers.allDocs({include_docs: true, descending: false}, function(err, doc) {
            var plist = '';
            doc.rows.forEach(function(p,index){
                plist += '<li><a class="dropdown-item" href="#" onclick="return scoreme(\'' + p.doc['name'] + '\',' + e + ')">' + p.doc['name'] + '</a></li>';
            }); 
            rocontrols += '<div class="dropdown">';
            rocontrols += '<button class="btn btn-secondary dropdown-toggle" type="button" id="';
            rocontrols += e;
            rocontrols += 'folx" data-bs-toggle="dropdown" aria-expanded="false">';    
            rocontrols += '$' + e + '';
            rocontrols += '</button>';
            rocontrols += '<ul class="dropdown-menu" aria-labelledby="' + e + 'folx">';
            rocontrols += plist;
            rocontrols += '</ul>';
            rocontrols += '</div>';
            document.getElementById('roundone').innerHTML = rocontrols;
        });
    });

    var rtcontrols = '';
    var plist = '';
    rndtwo.forEach(function(e,index){
        dbplayers.allDocs({include_docs: true, descending: false}, function(err, doc) {
            var ptwolist = '';
            doc.rows.forEach(function(p,index){
                ptwolist += '<li><a class="dropdown-item" href="#" onclick="return scoreme(\'' + p.doc['name'] + '\',' + e + ')">' + p.doc['name'] + '</a></li>';
            }); 
            rtcontrols += '<div class="dropdown">';
            rtcontrols += '<button class="btn btn-secondary dropdown-toggle" type="button" id="';
            rtcontrols += e;
            rtcontrols += 'folx" data-bs-toggle="dropdown" aria-expanded="false">';    
            rtcontrols += '$' + e + '';
            rtcontrols += '</button>';
            rtcontrols += '<ul class="dropdown-menu" aria-labelledby="' + e + 'folx">';
            rtcontrols += ptwolist;
            rtcontrols += '</ul>';
            rtcontrols += '</div>';
            document.getElementById('roundtwo').innerHTML = rtcontrols;
        });
    });
    
}

function playersetup () {

    let playercontrols = ''; 

    dbplayers.allDocs({include_docs: true, descending: true}, function(err, doc) {
        doc.rows.forEach(function(e,index){

            playercontrols += '<div class="bg-dark px-3 py-1">';
            playercontrols += '<strong>' + e.doc['name'] + '</strong>';
            playercontrols += '<div id="' + e.doc['name'].toLowerCase() + '"></div>';
            playercontrols += '</div>';
        });
        document.getElementById('app').innerHTML = playercontrols;

    });

}

function updatescores () {

    dbplayers.allDocs({include_docs: true, descending: true}, function(err, doc) {
    doc.rows.forEach(function(p,index){

        let pname = p.doc['name'];
        let pscore = 0;
        let pcount = 0;

        dbscores.allDocs({include_docs: true, descending: true}, function(err, doc) {

            doc.rows.forEach(function(e,index){

                if(e.doc['name'] == pname) {
                    pscore = pscore + Number(e.doc['score']);
                    pcount++;
                }

            });

            pmessage = '' + pcount + ' correct<br>$' + pscore;
            messageid = pname.toLowerCase();
            document.getElementById(messageid).innerHTML = pmessage;

        }); // end of db.allDocs()     
      
    });
    });

}

function scoreme (name,score) {	

    rightnow = new Date().getTime();
    var doc = {
        '_id' : rightnow.toString(),
        'date' : rightnow.toString(),
        'name' : name,
        'score' : score
    };
    dbscores.put(doc);
    updatescores();
    return false;

}

var form = document.querySelector('form');
form.addEventListener("submit", function(e) {

  e.preventDefault();
  
  var data = new FormData(form);
  for (const [name,value] of data) {
     
    if(name == 'playername') {
        rightnow = new Date().getTime();
        var doc = {
            '_id' : rightnow.toString(),
            'date' : rightnow.toString(),
            'name' : value
        };
        dbplayers.put(doc);
    }

  }
  playersetup();
  gridsetup();
  updatescores();
  
  form.reset();
})


function nuke() {

    dbplayers.allDocs({include_docs: true}).then(allDocs => {
    return allDocs.rows.map(row => {
        return {_id: row.id, _rev: row.doc._rev, _deleted: true};
    });
    }).then(deleteDocs => {
        return dbplayers.bulkDocs(deleteDocs);
    });
    dbscores.allDocs({include_docs: true}).then(allDocs => {
    return allDocs.rows.map(row => {
        return {_id: row.id, _rev: row.doc._rev, _deleted: true};
    });
    }).then(deleteDocs => {
        return dbscores.bulkDocs(deleteDocs);
    });
    playersetup();
    updatescores();
}
        
function resetscores() {

    dbscores.allDocs({include_docs: true}).then(allDocs => {
    return allDocs.rows.map(row => {
        return {_id: row.id, _rev: row.doc._rev, _deleted: true};
    });
    }).then(deleteDocs => {
        return dbscores.bulkDocs(deleteDocs);
    });
    updatescores();
}

</script>
</body>
</html>
